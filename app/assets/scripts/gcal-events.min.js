// code from http://www.codehandling.com/2013/03/your-google-calendar-events-now-on-your.html
// heavily modified to fit in with the bootstrap theme

var dateLowerlimit = "";
var tokenArray = ["start", "init"];
var tokenIndex = 1;

function getDateLowerLimit() {
    var todayDate;
    if (dateLowerlimit == "") {
        todayDate = new Date();
        dateLowerlimit = todayDate.getFullYear() + "-" + (todayDate.getMonth() < 10 ? '0' : '') + (todayDate.getMonth() + 1) + "-" + (todayDate.getDate() < 10 ? '0' : '') + todayDate.getDate() + "T00:00:00+00:00";
    } else {
        todayDate = new Date(dateLowerlimit)
    }
}

function getDate(dateTime, withMonth) {
    var monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    var dd = new Date(dateTime);
    if(withMonth) {
        return monthNames[dd.getMonth()] + " " + dd.getDate() ;
    }
    return dd.getDate();
}

function getTime(dateTime) {
    var dd = new Date(dateTime);
    return dd.getHours() + ":" + (dd.getMinutes() < 10 ? '0' : '') + dd.getMinutes();
}

$(window).load(function() {
    loadTumbo()
});

function loadTumbo() {
    var apiPostURL = "https://www.googleapis.com/calendar/v3/calendars/" + googleCalendarId + "/events";
    $('#gcal').empty().append('loading ...');
    getDateLowerLimit();
    var dataBox = {
        orderBy: "startTime",
        singleEvents: "true",
        timeMin: dateLowerlimit,
        fields: "items,nextPageToken",
        key: googleCalendarApiKey,
        maxResults: maxGcalEvents
    };
    pageToken = tokenArray[tokenIndex];
    if (null == pageToken || pageToken == "undefined" || pageToken == "") {
        $('#gcal').empty().append('Error .. Reload page!');
        return
    }
    if (pageToken == "init") {
        callAPI(apiPostURL, dataBox)
    } else if (pageToken == "start") {
    } else if (pageToken == "end") {
    } else {
        dataBox['pageToken'] = pageToken;
        callAPI(apiPostURL, dataBox)
    }
}

function callAPI(apiPostURL, dataBox) {
    $.ajax({
        url: apiPostURL,
        type: "GET",
        data: dataBox,
        async: true,
        cache: true,
        dataType: "jsonp",
        success: function(data) {
            showTumbo(data)
        },
        error: function(html) {
            alert(html)
        },
        beforeSend: setHeader
    })
}

function showTumbo(data) {
    $('#gcal').empty().append('<ul class="list-group" id="gcal-table"></ul>');
    var eventArray = data.items;
    if (tokenIndex == (tokenArray.length - 1)) {
        tokenArray.push((null == data.nextPageToken) ? "end" : data.nextPageToken)
    }
    eventHTML = "";
    var previousDate = 0;
    for (var i = 0; i < eventArray.length; i++) {
        startDate = eventArray[i].start.date || eventArray[i].start.dateTime;
        endDate = eventArray[i].end.date || eventArray[i].end.dateTime;
        summary = eventArray[i].summary;
        description = eventArray[i].description;
        htmlLink = eventArray[i].htmlLink;
        event_location = eventArray[i].location;
        if(previousDate == getDate(startDate, false)) {
            // generate another item
            //generate the time before the title/description
            eventHTML += '<li><span class="hive-event-time">' + getTime(startDate) + '</span> &ndash; ';
            //generate the title
            if (null != summary && summary != "undefined" && summary != "") {
                eventHTML += '<a href="' + htmlLink + '" class="hive-event-link">' + summary + '</a>';
            }
            eventHTML += '</li>';
        } else {
            if(i > 0) {
                eventHTML += '</ul></li>';
            }
            eventHTML += '<li class="list-group-item">';
            // generate the date heading
	    eventHTML += '<h4>';
	    if (null != startDate && startDate != "undefined" && startDate != "") {
                eventHTML += getDate(startDate, true)
            }
            eventHTML += '</h4>';
	    eventHTML += '<ul class="hive-event-list">';
	    //generate the time before the title/description
	    eventHTML += '<li><span class="hive-event-time">' + getTime(startDate) + '</span> &ndash; ';
	    //generate the title
            if (null != summary && summary != "undefined" && summary != "") {
                eventHTML += '<a href="' + htmlLink + '" class="hive-event-link">' + summary + '</a>';
            }
	    eventHTML += '</li>';
        }
        previousDate = getDate(startDate, false);
    }
    eventHTML += '</ul></li>';
    $('#gcal-table').append(eventHTML);
}

function setHeader(xhr) {
    if (xhr && xhr.overrideMimeType) {
        xhr.overrideMimeType("application/j-son;charset=UTF-8")
    }
}
